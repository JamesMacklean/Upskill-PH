{% extends 'base.html' %}
{% block content %}
<title>User List</title>
<div class="container">

    <h1>User List</h1>
    <form method="GET" action="{% url 'admin_dashboard' %}" class="d-flex">
        <input class="input-ctrl" type="text" name="search" placeholder="Search..." value="{{ search_query }}">
        <button class="btn btn-primary" class="mx-3" type="submit">Search</button>
        <button class="btn btn-primary" type="submit" name="generate_csv">Generate CSV</button>
    </form>
    
    <table border="1" id="user-table">
        <thead class="p-4 text-white bg-scholarium">
        <tr>
            <th onclick="sortTable(0)">ID</th>
            <th onclick="sortTable(1)">Username</th>
            <th onclick="sortTable(2)">First Name</th>
            <th onclick="sortTable(3)">Last Name</th>
            <th onclick="sortTable(4)">Email</th>
            <th onclick="sortTable(5)">Date Joined</th>
            <th onclick="sortTable(6)">Last Login</th>
            <th onclick="sortTable(7)">Is Global</th>
            <th onclick="sortTable(8)">Is Admin</th>
            <th onclick="sortTable(9)">Is Staff</th>
            <th onclick="sortTable(10)">Status</th>
        </tr>
        </thead>
        {% for user in users %}
        <tr>
            <td >{{ user.id }}</td>
            <td><a href="{% url 'user_details' user.id %}">{{ user.username }}</td>
            <td>{{ user.first_name }}</td>
            <td>{{ user.last_name }}</td>
            <td>{{ user.email }}</td>
            <td>{{ user.date_joined }}</td>
            <td>{{ user.last_login }}</td>
            <td>{{ user.is_global }}</td>
            <td>{{ user.is_admin }}</td>
            <td>{{ user.is_staff }}</td>
            <td>{{ user.status }}</td>
        </tr>
        {% endfor %}
    </table>
    <div class="pagination">
        <span class="step-links">
            {% if users.has_previous %}
            <a href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}">First</a>
            <a href="?page={{ users.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}">Previous</a>
            {% endif %}
            
            <span class="current">
                Page {{ users.number }} of {{ users.paginator.num_pages }}.
            </span>
            
            {% if users.has_next %}
            <a href="?page={{ users.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}">Next</a>
            <a href="?page={{ paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}">Last</a>
            {% endif %}
        </span>
    </div> 
    <div>
        <canvas id="user-chart" width="800" height="400"></canvas>
    </div>

</div>
<script>
    var sortOrders = [];
    function sortTable(colIndex) {
        var table, rows, switching, i, x, y, shouldSwitch;
        table = document.getElementById("user-table");
        switching = true;
    
        if (!sortOrders[colIndex]) {
            sortOrders[colIndex] = "asc";
        } else if (sortOrders[colIndex] === "asc") {
            sortOrders[colIndex] = "desc";
        } else {
            sortOrders[colIndex] = "asc";
        }
    
        while (switching) {
            switching = false;
            rows = table.rows;
            for (i = 1; i < (rows.length - 1); i++) {
                shouldSwitch = false;
    
                x = rows[i].getElementsByTagName("td")[colIndex];
                y = rows[i + 1].getElementsByTagName("td")[colIndex];
    
                if (sortOrders[colIndex] === "asc") {
                    if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
                        shouldSwitch = true;
                        break;
                    }
                } else if (sortOrders[colIndex] === "desc") {
                    if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
                        shouldSwitch = true;
                        break;
                    }
                }
            }
            if (shouldSwitch) {
                rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                switching = true;
            }
        }
    }
</script>
{% endblock %}